<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../responsive-utility/responsive-utility.html">
<link rel="import" href="screenfull-lib.html">
<link rel="import" href="a11y-media-play-button.html">
<link rel="import" href="a11y-media-number-input.html">
<link rel="import" href="a11y-media-button.html">

<!--
`a11y-media-player`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="a11y-media-player">
  <template>
    <style>
      :host {
        display: block;
      }
      :host, 
      :host #controls, 
      :host #slider, 
      :host #media-inner,
      :host #media-inner > * {
        width: 100%;
      }
      :host #media {
        z-index: 1;
      }
      :host #player-inner {
        background-color: black;
      }
      :host #media-inner {
        padding-top: 57.2%;
        position: relative;
      }
      :host #video {
        position: absolute;
        top: 0;
        left: 0;
      }
      :host #playbutton {
        padding-top: 57.2%;
        opacity: 1;
        -webkit-transition: opacity 0.5s;
        -moz-transition: opacity 0.5s;
        transition: opacity 0.5s;
      }
      :host #playbutton[disabled], 
      :host[playing] #playbutton {
        opacity: 0;
      }
      :host paper-icon-button {
        border: none;
        background-color: black;
        color: #bbb;
      }
      :host paper-icon-button:active,
      :host paper-icon-button:focus,
      :host paper-icon-button:hover {
        color: #fff;
      }
      :host paper-listbox {
        padding: 0;
      }
      :host paper-item, 
      :host paper-listbox {
        color: white;
        background-color: black;
      }
      :host paper-item {
        min-height: 40;
      }
      :host paper-toggle-button {
        --paper-toggle-button-unchecked-bar-color:  #eeeeee;
        --paper-toggle-button-unchecked-button-color:  #f8f8f8;
        --paper-toggle-button-checked-bar-color:  #00fffd;
        --paper-toggle-button-checked-button-color:  #00eeff;
      }
      :host paper-slider {
        z-index: 3;
        --paper-slider-knob-color: #transparent;
        --paper-slider-knob-start-color: transparent;
        --paper-slider-knob-start-border-color: transparent;
        --paper-slider-knob-end-color: transparent;
        --paper-slider-knob-end-border-color: transparent;
        --paper-slider-active-color: #00fffd;
        --paper-slider-secondary-color: #4E7373;
        --paper-slider-pin-color: #444;
        --paper-slider-pin-start-color: #444;
      }
      :host paper-item .menu-text {
        display: inline-block;
        width: 130px;
      }
      :host paper-item .menu-text2 {
        width: 60px;
      }
      :host paper-item paper-slider {
        width: 110px;
        --paper-slider-knob-color: #00eeff;
        --paper-slider-knob-start-color: #00eeff;
        --paper-slider-knob-end-color: #00eeff;
      }
    </style>
    <div id="player-inner">
      <div id="media">
        <div id="media-inner">
          <video 
            autoplay$="[[autoplay]]" 
            id="video" 
            loop$="[[loop]]" 
            muted$="[[muted]]">
            <slot></slot>
          </video>
          <a11y-media-play-button id="playbutton"></a11y-media-play-button>
        </div>
      </div>
      <paper-slider id="slider" max$="[[duration]]" pin secondary-progress$="[[buffered]]" tab-index="-1" value$="[[elapsed]]"></paper-slider>
      <div id="controls">
        <a11y-media-button icon="av:replay" label="restart"></a11y-media-button>
        <a11y-media-button icon="av:fast-rewind" label="backward"></a11y-media-button>
        <a11y-media-button icon="[[playPause.icon]]" label="[[playPause.label]]"></a11y-media-button>
        <a11y-media-button icon="av:fast-forward" label="forward"></a11y-media-button>
        <a11y-media-button icon="[[muteUnmute.icon]]" label="[[muteUnmute.label]]"></a11y-media-button>
        <template is="dom-if" if="[[__showFullscreen]]">
          <a11y-media-button icon="fullscreen" label="full screen" toggle$="[[fullscreen]]" step="1"></a11y-media-button>
        </template>
        <paper-menu-button id="settings" vertical-align="bottom" close-on-activate="false">
          <paper-icon-button icon="settings" slot="dropdown-trigger" alt="Settings"></paper-icon-button>
          <paper-listbox slot="dropdown-content">
            <paper-item>
              <div class="menu-text">Autoplay </div>
              <paper-toggle-button id="autoplay"></paper-toggle-button>
            </paper-item>
            <paper-item>
              <div class="menu-text">Loop </div>
              <paper-toggle-button id="loop"></paper-toggle-button></paper-item>
            <paper-item>
              <div class="menu-text">Captions </div>
              <paper-toggle-button id="captions"></paper-toggle-button>
            </paper-item>
            <paper-item>
              <div class="menu-text2">Speed </div>
              <paper-slider id="speed" min="50" max="400" pin step="50" tab-index="-1" value$="[[playbackRate]]"></paper-slider>
            </paper-item>
            <paper-item>
              <div class="menu-text2">Volume </div>
              <paper-slider id="volume" min="0" max="100" pin step="10" tab-index="-1" value$="[[volume]]"></paper-slider>
            </paper-item>
          </paper-listbox>
        </paper-menu-button>
        <paper-tooltip for="settings">settings</paper-tooltip>
      </div>
    </div>
    <div id="length"></div>
    <iron-a11y-keys id="a11y" keys="up right" target$="[[__slider]]"
    on-keys-pressed="forward"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" keys="down left" target$="[[__slider]]"
    on-keys-pressed="rewind"></iron-a11y-keys>
  </template>

  <script>
    Polymer({

      is: 'a11y-media-player',

      listeners: {
        'play-button-clicked': 'play',
        'button-clicked': '_onButtonClick',
        'change': '_onSettingsChanged',
      },

      properties: {
        /* 
         * fullscreen option 
         */
        allowFullscreen: {
          type: Boolean,
          value: true,
        },
        /* autoplay is an option, 
         * but generally not recommended for a11y
         */ 
        autoplay: {
          type: Boolean,
          value: false,
        },
        /*
         * media aspect ratio
         */
         aspect: {
          type: String,
          value: null,
        },
        /*
         * buffered video in seconds
         */
        buffered: {
          type: Number,
          value: 0,
        },
        /*
         * show closed captions
         */
        cc: {
          type: Boolean,
          value: false,
        },
        /*
         * duration of video in seconds
         */
        duration: {
          type: Number,
          value: 0,
        },
        /*
         * elapsed time in seconds
         */
        elapsed: {
          type: Number,
          value: 0,
        },
        /* 
         * is fullscreen mode
         */
        fullscreen: {
          type: Boolean,
          value: false,
        },
        /*
         * language
         */
        lang: {
          type: String,
          value: 'en',
          reflectToAttribute: true,
        },
        /*
         * length of video
         */
        length: {
          type: String,
          value: '',
        },
        /* 
         * looping is not fully supported
         */
        loop: {
          type: Boolean,
          value: false,
        },
        /* 
         * is audio muted
         */
        muted: {
          type: Boolean,
          value: false,
        },
        /*
         * is media playing
         */
        playing: {
          type: String,
          value: false,
          reflectToAttribute: true
        },
        /*
         * playback rate where 1 is normal speed, 0.5 is half-speed, and 2 is double speed
         */
        playbackRate: {
          type: Number,
          value: 100
        },
        /*
         * play/pause button
         */
        playPause: {
          type: Object,
          computed: '_getPlayPause(playing)'
        },
        /*
         * mute/unmute button
         */
        muteUnmute: {
          type: Object,
          computed: '_getMuteUnmute(muted)'
        },
        /* 
         * Range is 0 to 10. Default should not be loud enough to overpower screen readers. */
        volume: {
          type: Number,
          value: 70,
        },
      },
      ready: function(){
        let root = this, video = this.$.video;
        root.__slider = root.$.slider;
        root.__resumePlaying = false;
        root.__showFullscreen = this.allowFullscreen && screenfull.enabled;
        if(root.__showFullscreen) {
          screenfull.on('change', () => { this.fullscreen = screenfull.isFullscreen });
        }
        root.$.slider.addEventListener('dragging-changed', (e) => {
          if (!root.$.slider.dragging) { 
            root.seek(root.$.slider.immediateValue);
            if (root.__resumePlaying) root.play();
            root.__resumePlaying = false;
          }
        });
        root.$.slider.addEventListener('focused-changed', (e) => {
          if(root.$.slider.focused){
            if (root.playing) root.__resumePlaying = true;
            root.pause();
          } else {
            root.seek(root.$.slider.value);
            if (root.__resumePlaying) root.play();
            root.__resumePlaying = false;
          }
        });
        root.__getLength = setInterval(() => {
          if(root.duration === 0) { 
            root.duration = video.duration > 0 ? video.duration: 0; 
          } else {
           clearInterval(root.__getLength);
          } 
        }, 1);
      },
      /* play the media */
      play: function(e){
        let root = this;
        if (e === undefined || e.detail === root.$.playbutton) {
          root.$.playbutton.setAttribute('disabled',true);
          root.playing = true;

          root.__playProgress = setInterval(() => {
            root.elapsed = video.currentTime > 0 ? video.currentTime : 0;
            root.$.length.innerHTML = root._convertTime(video.currentTime,video.duration) +'/'+ root._convertTime(video.duration);
            
            if(root.elapsed == root.duration && !root.loop){
              root.$.playbutton.removeAttribute('disabled');
              root.playing = false;
            }
            root.buffered = video.buffered.length > 0 ? video.buffered.end(0) : root.elapsed;
          }, 1);

          root.$.video.play();
        }
      },
      /* play the media */
      pause: function(e){
        let root = this;
        root.playing = false;
        root.$.video.pause();
        clearInterval(root.__playProgress);
      },
      /* play the media */
      rewind: function(amt){
        amt = amt !== undefined ? amt : 1;
        this.seek(Math.max(this.$.video.currentTime - amt,0));
      },
      /* play the media */
      forward: function(amt){
        amt = amt !== undefined ? amt : 1;
        this.seek(Math.min(this.$.video.currentTime + amt,this.$.video.duration));
      },
      /* seek to a time */
      seek: function(time){
        let seekable = this.$.video.seekable;
        if (seekable.length > 0 && time >= seekable.start(0) && time <= seekable.end(0)) {
          this.$.video.currentTime = time;
        }
      },
      /* toggle mute */
      toggleMute: function(mode){
        mode = mode === undefined ? !this.muted : mode;
        this.muted = mode;
        console.log('mute',this.muted,this.$.video.muted);
        this.$.video.muted = this.muted;
      },
      /* set play/pause button */
      _convertTime: function(val,max){
        max = max === undefined ? val : max;
        let a = (val) => { return val < 10 ? '0' + val : val; }, 
        b = (val,i) => { return Math.floor(max/i) > 0 ? a(Math.floor(val/i))+':' : '' },
        c = (val) => { return Math.floor(max/3600) > 0 ? a(Math.round(val)) : a(Math.floor(val))+'.'+a(Math.round(val*10)) };
        return b(val,3600)+b(val%3600,60)+c(val%60);
      },
      /* set play/pause button */
      _getPlayPause: function(playing){
        return playing ? {'icon': 'av:pause', 'label': 'pause'} : {'icon': 'av:play-arrow', 'label': 'play'};
      },
      /* set play/pause button */
      _getMuteUnmute: function(muted){
        return muted ? {'icon': 'av:volume-off', 'label': 'unmute'} : {'icon': 'av:volume-up', 'label': 'mute'};
      },
      /* seeks to slider position when slider is dragged */
      _onSliderChange: function(slider){
        this.seek(slider.value);
      },
      /* resume updating value via playback */
      _onDraggingChange: function(root){
        if(root.$.slider.dragging){
          root.$.slider.addEventListener('value-changed',root._onSliderChange(root.$.slider));
        } else {
          this.seek(e.target.value);
          root.$.slider.removeEventListener('value-changed',root._onSliderChange(root.$.slider));
        }
        this.__dragging = root.$.slider.dragging; 
      },
      /* determine which button was clicked and act accordingly */
      _onButtonClick: function(e){
        if(e.detail.parentNode === this.$.controls) {
          if (e.detail.label === 'backward') {
            this.rewind(this.$.video.duration/20);
          } else if (e.detail.label === 'closed captions') {
            this.toggleCC();
          } else if (e.detail.label === 'forward') {
            this.forward(this.$.video.duration/20);
          } else if (e.detail.label === 'full screen') {
            screenfull.toggle(this);
          } else if (e.detail.label === 'loop') {
            this.toggleLoop();
          } else if (e.detail.label === 'mute' || e.detail.label === 'unmute') {
            this.toggleMute();
          } else if (e.detail.label === 'pause') {
            this.pause();
          } else if (e.detail.label === 'play') {
            this.play();
          } else if (e.detail.label === 'restart') {
            this.seek(0);
            this.play();
          }
        }
      },
      /* determine which button was clicked and act accordingly */
      _onSettingsChanged: function(e){
        if (e.target === this.$.autoplay) {
          this.$.video.autoplay = e.target.checked;
        } else if (e.target === this.$.captions) {
          console.log('TODO: captions');
        } else if (e.target === this.$.loop) {
          this.$.video.loop = e.target.checked;
        } else if (e.target === this.$.volume) {
          this.$.video.volume = e.target.value !== null ? e.target.value/100 : 0.7;
          this.$.video.muted = e.target.value !== null && e.target.value > 0;
        } else if (e.target === this.$.speed) {
          this.$.video.playbackRate = e.target.value !== null ? e.target.value/100 : 1;
        }
      }
    });
  </script>
</dom-module>
