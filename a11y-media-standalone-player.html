<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../web-animations-js/web-animations-next-lite.min.html">
<link rel="import" href="../simple-colors/simple-colors.html">
<link rel="import" href="screenfull-lib.html">
<link rel="import" href="a11y-media-behaviors.html">
<link rel="import" href="a11y-media-play-button.html">
<link rel="import" href="a11y-media-controls.html">
<link rel="import" href="a11y-media-transcript.html">
<link rel="import" href="a11y-media-utility.html">


<!--
`a11y-media-standalone-player`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element

  <a11y-media-standalone-player 
    accent-color$="[[accentColor]]"             // Optional accent color for controls, 
                                                // using the following materialize colors: 
                                                // red, pink, purple, deep-purple, indigo, blue, 
                                                // light blue, cyan, teal, green, light green, lime, 
                                                // yellow, amber, orange, deep-orange, and brown. 
                                                // Default is null. 
    allow-fullscreen$="[[allowFullscreen]]"         // Allow fullscreen mode?
    audio-only$="[[audioOnly]]"                 // Is media audio only?
    autoplay$="[[autoplay]]"                    // Is player set to autoplay (not recommended for a11y)?
    cc$="[[cc]]"                                // Are closed captions toggled?
    custom-microcopy$="[[customMicrocopy]]"     // Optional customization or text and icons
    dark$="[[dark]]"                            // Is the color scheme dark? Default is light.    
    disableFullscreen$="[[disableFullscreen]]"  // Is full screen mode disabled?
    fullscreen$="[[fullscreen]]"                // Is full screen mode toggled on?
    height$="[[height]]"                        // The height of player
    hide-elapsed-time$="[[hideElapsedTime]]"    // Is elapsed time hidden?
    lang$="[[lang]]"                            // The language of the media
    loop$="[[loop]]"                            // Is video on a loop?
    muted$="[[muted]]"                          // Is video muted?
    volume$="[[volume]]"                        // The initial volume of the video
    width$="[[width]]">                         // The width of player
                                                // video source and tracks 
    <source src="/path/to/video.mp4" type="video/mp4">
    <source src="/path/to/video.webm" type="video/webm">
    <track label="English" kind="subtitles" srclang="en" src="path/to/subtitles/en.vtt" default>
    <track label="Deutsch" kind="subtitles" srclang="de" src="path/to/subtitles/de.vtt">
    <track label="EspaÃ±ol" kind="subtitles" srclang="es" src="path/to/subtitles/es.vtt">
  </a11y-media-standalone-player>

 Basic customization of player:
--a11y-media-text-color: text color, default is #bbbbbb
--a11y-media-bg-color: background color, default is #000000
--a11y-media-hover-color: text color on hover, default is #ffffff
--a11y-media-accent-color: an accent color, default is #00b0ff
--a11y-media-faded-accent-color: a subtler version of accent color, default is #4E7373
 
 Custom styles for player buttons:
--a11y-media-button-color: button text color, default is --a11y-media-text-color
--a11y-media-button-bg-color: button background color, default is --a11y-media-bg-color
--a11y-media-button-hover-color: button text color when focused/hovered, default is --a11y-media-hover-color
--a11y-media-button-hover-bg-color: button background color when focused/hovered, default is --a11y-media-bg-color
 
 Custom styles for player settings menu:
--a11y-media-settings-menu-color: settings menu text color, default is --a11y-media-text-color
--a11y-media-settings-menu-bg-color: settings menu background color, default is --a11y-media-bg-color
 
 Custom styles for player toggle buttons:
--a11y-toggle-off-color: color of toggle button when off, default is #f8f8f8
--a11y-toggle-on-color: color of toggle button when on, default is --a11y-media-accent-color
 
 Custom styles for player slider buttons:
--a11y-media-slider-primary-color: primary slider color, default is --a11y-media-accent-color
--a11y-media-slider-buffer-color: slider buffer color, default is --a11y-media-faded-accent-color
--a11y-media-slider-pin-color: color of the pin that shows slider value, default is #444444
--a11y-media-slider-knob-color: slider knob color, default is --a11y-media-accent-color

 Custom styles for player volume slider:
--a11y-media-volume-primary-color: volume slider color, default is #00b0ff
--a11y-media-volume-pin-color: color of the pin that shows volume slider value, default is #444444
--a11y-media-volume-knob-color: volume slider knob color, default is #00b0ff
--a11y-media-volume-knob-start-color: knob color at the start of volume slider, default is --a11y-media-hover-color
--a11y-media-volume-knob-end-color: knob color at the end of volume slider, default is --a11y-media-volume-knob-color

 Custom styles for player speed slider:
--a11y-media-speed-primary-color: speed slider color, default is #00b0ff
--a11y-media-speed-pin-color: color of the pin that shows speed slider value, default is #444444
--a11y-media-speed-knob-color: volume slider knob color, default is #00b0ff
--a11y-media-speed-knob-start-color: knob color at the start of speed slider, default is --a11y-media-speed-knob-color
--a11y-media-speed-knob-end-color: knob color at the end of speed slider, default is --a11y-media-speed-knob-color
-->

<dom-module id="a11y-media-standalone-player">
  <template>
    <style is="custom-style" include="simple-colors">
      :host {
        display: block;
        max-width: 100%;
        transition: position 0.5s ease, max-width 1s ease;
        background-color: var(--simple-colors-background2);
        --a11y-media-color: var(--simple-colors-foreground2);
        --a11y-media-bg-color: var(--simple-colors-background2);
        --a11y-media-hover-color: var(--simple-colors-foreground1);
        --a11y-media-hover-bg-color: var(--simple-colors-background2);
        --a11y-media-accent-color: var(--simple-colors-accent-foreground2);
        --a11y-media-faded-accent-color: var(--simple-colors-accent-foreground3);
      }
      :host, :host #controls {
        color: var(--a11y-media-color);
        background-color: var(--a11y-media-bg-color);
      }
      :host, :host * {
        /* settings */
        --a11y-media-settings-menu-color: var(--a11y-media-color);
        --a11y-media-settings-menu-bg-color: var(--a11y-media-bg-color);
        --a11y-media-settings-menu-hover-color: var(--a11y-media-hover-color);
        --a11y-media-settings-menu-hover-bg-color: var(--a11y-media-hover-bg-color);
        
        /* buttons */
        --a11y-media-button-color: var(--a11y-media-color);
        --a11y-media-button-bg-color: var(--a11y-media-bg-color);
        --a11y-media-button-hover-color: var(--a11y-media-accent-color);
        --a11y-media-button-hover-bg-color: var(--a11y-media-hover-bg-color);
        --a11y-media-button-toggle-color: var(--a11y-media-faded-accent-color);

        /* giant play button */
        --a11y-play-button-bg-color: var(--simple-colors-background1);
        --a11y-play-button-focus-bg-color: var(--simple-colors-background1);
        
        /* toggle button */
        --paper-toggle-button-unchecked-bar-color: var(--a11y-media-color);
        --paper-toggle-button-unchecked-button-color: var(--a11y-media-color);
        --paper-toggle-button-checked-bar-color: var(--a11y-media-accent-color);
        --paper-toggle-button-checked-button-color: var(--a11y-media-accent-color);
        
        /* slider */
        --paper-slider-active-color: var(--a11y-media-accent-color);
        --paper-slider-secondary-color:  var(--a11y-media-faded-accent-color);
        --paper-slider-pin-color: var(--a11y-media-faded-bg-color);
        --paper-slider-pin-start-color: var(--a11y-media-faded-bg-color);
        --paper-slider-pin-end-color: var(--a11y-media-faded-bg-color);
        --paper-slider-knob-color: var(--a11y-media-accent-color);
        --paper-slider-knob-start-border-color: var(--a11y-media-bg-color);
        --paper-slider-knob-end-border-color: var(--a11y-media-bg-color);
        --paper-slider-knob-start-color: var(--a11y-media-bg-color);
        --paper-slider-knob-end-color: var(--a11y-media-bg-color);
      }
      :host[sticky]:not([sticky-corner="none"]) {
        position: fixed;
        top: 5px;
        right: 5px;
        max-width: 200px;
        z-index: 999999;
        border: 1px solid;
        box-shadow: 1px 1px 20px 1px rgba(125,125,125);
        border-radius: 0.2em; 
        border-color: var(--a11y-media-bg-color);
      }
      :host[dark][sticky]:not([sticky-corner="none"]) {
        border-color: var(--a11y-media-bg-color);
      }
      :host[sticky][sticky-corner="top-left"] {
        right: unset;
        left: 5px;
      }
      :host[sticky][sticky-corner="bottom-left"] {
        top: unset;
        right: unset;
        bottom: 5px;
      }
      :host[sticky][sticky-corner="bottom-right"] {
        top: unset;
        bottom: 5px;
      }
      :host #audio-only {
        text-align: center;
        font-style: italic;
        width: 100%;
        line-height: 160%;
      }
      :host #print-only {
        display: none;
      }
      :host #player-inner {
        z-index: 1;
      }
      :host #slider,
      :host #controls {
        z-index: 2 !important;
      }
      :host #media {
        display: flex;
        align-items: stretch;
        position: relative;
      }
      :host[no-height] #media {
        display: none;
      }
      :host #media,
      :host #media > *, 
      :host #slider,
      :host #controls {
        width: 100%;
      }
      :host #video {
        position: absolute;
        top: 0;
        left: 0;
      }
      :host #player-inner, 
      :host #media > * {
        max-height: 80vh;
      }

      @media print {
        :host {
          color: #000000;
          background-color: #f8f8f8;
          padding: 15px;
          width: auto;
        }
        :host:not([thumbnail-src]) #media, 
        :host #slider, 
        :host #video, 
        :host #audio, 
        :host #controls {
          display: none;
        }
        :host #print-only {
          display: inline;
        }
        :host #print-only .media-type {
          font-style: italic;
        }
      }
    </style>
    <div lang$="[[uiLanguage]]">
      <span id="print-only">
        [[mediaTitle]] (<span class="media-type" hidden$="[[audioOnly]]">[[videoLabel]]</span><span class="media-type" hidden$="[[!audioOnly]]">[[audioLabel]]</span>)
      </span>
      <div id="player">
        <div id="player-inner">
          <div id="media" hidden$="[[noHeight]]">
            <a11y-media-play-button 
              audio-only$="[[audioOnly]]" 
              disabled="true"
              hidden$="[[noHeight]]"
              id="playbutton" 
              pause-label$="[[pauseLabel]]" 
              playing$="[[__playing]]"
              play-label$="[[playLabel]]" 
              thumbnail-src$="[[thumbnailSrc]]">
            </a11y-media-play-button>
            <video 
              autoplay$="[[autoplay]]" 
              hidden$="[[audioOnly]]"
              id="video" 
              lang$="[[lang]]"
              loop$="[[loop]]" 
              muted$="[[muted]]" 
              preload="metadata">
              <slot></slot>
              HTML5 video not supported 
            </video>
            <audio 
              autoplay$="[[autoplay]]" 
              hidden$="[[!audioOnly]]"
              id="audio" 
              lang$="[[lang]]"
              loop$="[[loop]]" 
              muted$="[[muted]]" 
              preload="metadata">
              <slot></slot>
              HTML5 audio not supported 
            </audio>
          </div>
        </div>
        <paper-slider 
          id="slider" 
          max$="[[__duration]]" 
          pin 
          secondary-progress$="[[__buffered]]" 
          value$="[[__elapsed]]">
        </paper-slider>
      </div>
      <a11y-media-controls 
        audio-label$="[[audioLabel]]" 
        captions-label$="[[captionsLabel]]" 
        captions-icon$="[[captionsIcon]]" 
        captions-menu-label$="[[captionsMenuLabel]]" 
        captions-menu-off$="[[captionsMenuOff]]" 
        cc$="[[cc]]"
        forward-label$="[[forwardLabel]]" 
        forward-icon$="[[forwardIcon]]" 
        fullscreen-label$="[[fullscreenLabel]]" 
        fullscreen-icon$="[[fullscreenIcon]]" 
        has-captions$="[[hasCaptions]]"
        has-transcript$="[[hasTranscript]]"
        id="controls"
        lang$="[[uiLanguage]]"
        length="[[__length]]"
        loop-label$="[[loopLabel]]" 
        mute-label$="[[muteLabel]]" 
        mute-icon$="[[muteIcon]]" 
        muted$="[[muted]]"
        pause-label$="[[pauseLabel]]" 
        pause-icon$="[[pauseIcon]]" 
        play-label$="[[playLabel]]" 
        play-icon$="[[playIcon]]" 
        playing$="[[__playing]]"
        print-label$="[[printLabel]]" 
        print-icon$="[[printIcon]]" 
        restart-label$="[[restartLabel]]" 
        restart-icon$="[[restartIcon]]" 
        search-transcript$="[[searchTranscript]]" 
        settings-label$="[[settingsLabel]]" 
        settings-icon$="[[settingsIcon]]" 
        rewind-label$="[[rewindLabel]]" 
        rewind-icon$="[[rewindIcon]]" 
        speed-label$="[[speedLabel]]"  
        transcript-label$="[[transcriptLabel]]" 
        transcript-icon$="[[transcriptIcon]]"
        transcript-menu-label$="[[transcriptMenuLabel]]"
        unmute-label$="[[unmuteLabel]]" 
        unmute-icon$="[[unmuteIcon]]" 
        volume="[[__volume]]"
        volume-label$="[[volumeLabel]]" 
        video-label$="[[videoLabel]]">
      </a11y-media-controls>
      <div id="audio-only" hidden$="[[!audioOnly]]">(audio only)</div>
    </div>
  </template>

  <script>
    Polymer({

      is: 'a11y-media-standalone-player',

      listeners: {
        'controls-change': '_onControlsChanged',
        'play-button-tapped': 'play',
        'thumbnail-aspect': '_setPaddingTop'
      },
      
      behaviors: [
        a11yMediaBehaviors.MediaProps,
        a11yMediaBehaviors.UILanguageProps,
        a11yMediaBehaviors.GeneralFunctions,
        a11yMediaBehaviors.PlayerBehaviors, 
        simpleColorsBehaviors 
      ], 

      /**
        * calls responsive-utility to get parent's responsive size
        */ 
      attached: function(){
        Polymer.SimpleColorsUtility.requestAvailability();
        Polymer.A11yMediaUtility.requestAvailability();
        this._addResponsiveUtility();
        this.fire('a11y-player',this);
      },
      ready: function(){
        let root = this, tracks = new Array();
        root.__src = root.$.video !== undefined ? root.$.video : root.$.audio
        root.__status = 'Loading...';
        root.__slider = root.$.slider;
        root.__volume = root.muted ? 0 : Math.max(this.volume,10);
        root.__resumePlaying = false;
        root.__showFullscreen = this.allowFullscreen && screenfull.enabled;
        root.$.controls.setStatus(root.__status);

        // handles fullscreen
        if(root.__showFullscreen) {
          screenfull.on('change', () => { this.fullscreen = screenfull.isFullscreen });
        }
        // handles dragging with a mouse
        root.$.slider.addEventListener('dragging-changed', (e) => {
          // when dragging stops, seeks to that value and 
          // if the video was playing before the dragging, resumes it
          if (!root.$.slider.dragging) { 
            root.seek(root.$.slider.immediateValue);
            root.__resumePlaying = false;
          }
        });
        // handles slider focus
        root.$.slider.addEventListener('focused-changed', (e) => {
          // temporarily pauses playback so that a value can be selected, 
          // but notes if playing should be resumed
          if(root.$.slider.focused){
            if (root.__playing) root.__resumePlaying = true;
            root.pause();
          } else {
            root.seek(root.$.slider.value);
            root.__resumePlaying = false;
          }
        });
        //adjusts video width and height based on attributes
        if (root.width === 'unset' && root.height === 'unset'){
          root.style.width = '100%';  
        } else if (root.width === 'unset' && root.height !== 'unset') {
          root.style.height = root.height;
        } else {
          root.style.width = root.width;  
        }
        // handles loaded metadata
        root.__src.addEventListener('loadedmetadata',function(){
          // adjusts aspect ratio
          if (root.width !== 'unset') root.setAttribute('width',root.width);
          if (root.height !== 'unset') root.setAttribute('height',root.height);
          let aspect = root.__src.videoHeight/root.__src.videoWidth * 100;
          root.$.media.style.paddingTop = aspect+'%';
          root.$.playbutton.removeAttribute('disabled');
          // gets and converts video duration
          root.__duration = root.__src.duration > 0 ? root.__src.duration: 0; 
          root.__status = root._convertTime(0,root.__src.duration)+'/'+root._convertTime(root.__src.duration);
          root.$.controls.setStatus(root.__status);

          // hides the video subtitles and captions and adds them to the tracks dropdown-select
          if (root.__src.textTracks.length > 0) {
            root.hasCaptions = true;
            root.selectTrack(0);
          }
          
          // gets cues from tracks
          for(i in root.__src.textTracks) {
            let cues = {};
            if (root.__src.textTracks[i] !== null) {
              let text = root.__src.textTracks[i].label !== undefined ? root.__src.textTracks[i].label : root.__src.textTracks[i].language;
              if(text !== undefined){
                let track = root.__src.textTracks[i];
                root.setAttribute('has-captions',true);
                tracks.push({
                  'text': text, 
                  'language': track.language, 
                  'value': i
                });
                track.oncuechange = function(e){
                  if (root.__transcript !== undefined && root.__transcript !== null) {
                    root.__transcript.setActiveCues(Object.keys(e.currentTarget.activeCues).map(function(key) { 
                      return e.currentTarget.activeCues[key].id;
                    }));
                  }
                };
              }
            }
          }
          root.set('__tracks', tracks);
          root.$.controls.setTracks(tracks);

          if (root.__transcript !== undefined && root.__transcript !== null) {
            let complete = 0;
            for (var i=0 ; i < tracks.length; i++) {
              let itrack = tracks[i], track = root.__src.textTracks[i], loaded = itrack.cues !== undefined;
              if(!loaded){
                track.mode = 'showing';
                let temp = setInterval(() => {
                  if (track.cues.length > 0) {
                    track.mode = 'hidden';
                    itrack.cues = Object.keys(track.cues).map(function(key) { 
                      return {
                        "order": track.cues[key].id,
                        "seek": track.cues[key].startTime,
                        "start": root._convertTime(track.cues[key].startTime,root.__src.duration),
                        "end": root._convertTime(track.cues[key].endTime,root.__src.duration), 
                        "text": track.cues[key].text
                      };
                    });
                    complete++;
                    if (complete === tracks.length && root.__transcript !== null) {
                      root.__transcript.setTracks(tracks);
                      root.__transcript.setAttribute('selected-transcript',root.__selectedTrackId);
                    }
                    clearInterval(temp);
                  }
                },1);
              }
            }
          }
        });
        // when transcript is ready associate it with the player
        document.body.addEventListener('transcript-ready',function(e){
          if((root.getAttribute('id') !== null && root.getAttribute('id') === e.detail.mediaId) || root === e.detail.media) {
            root.__transcript = e.detail;
            root.hasTranscript = true;
            if (root.__tracks !== undefined) {
              root.__transcript.setTracks(tracks);
              root.$.controls.setTracks(tracks);
            }
            root.__transcript.addEventListener('cue-seek',function(e){
              root.seek(e.detail.cue.seek);
            });
          }
        });
      },
      /** 
       * selects a specific track by index
       */
      selectTrack: function(index){
        for(i in this.__src.textTracks) {
          if (index == i) {
            this.__src.textTracks[i].mode = 'showing';
            this.__selectedTrack = this.__src.textTracks[i];
            this.__selectedTrackId = i;
          } else if (this.__src.textTracks[i] !== null) {
            this.__src.textTracks[i].mode = 'hidden';
          }
        }
        if (this.__transcript !== undefined && this.__transcript !== null && this.__transcript.tracks !== null) {
          this.__transcript.setAttribute('selected-transcript',this.__selectedTrackId);
        }
      },
      _setPaddingTop: function(e){
        this.$.media.style.paddingTop = e.detail+'%';
      }
    });
  </script>
</dom-module>
