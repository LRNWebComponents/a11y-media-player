<link rel="import" href="../polymer/polymer.html">

<!--
`a11y-media-youtube-utility`
Utily to control

@demo demo/index.html

@microcopy - the mental model for this element

-->

<dom-module id="a11y-media-youtube-utility">
  <template>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      function onYouTubeIframeAPIReady() {
        var event = new CustomEvent('youtube-api-ready');
        document.dispatchEvent(event);
      }
    </script>
  </template>
  <script>
    (function() {
      'use strict';
  
      Polymer.A11yMediaYoutubeUtility = Polymer({

        is: 'a11y-media-youtube-utility',
        
        /**
         * Makes sure there is a utility ready and listening for elements.
         */
        created: function() {
          let root = Polymer.A11yMediaYoutubeUtility;
          root.ready = 
          document.addEventListener('youtube-api-ready', function(e) {
            for(let i=0; i<root.players.length; i++){
              root.players[i].player = root.initYoutubePlayer(root.players[i]);
            }
            root.apiReady = true;
          });
        },
      });

      Polymer.A11yMediaYoutubeUtility.instance = null;

      Polymer.A11yMediaYoutubeUtility.apiReady = false;

      Polymer.A11yMediaYoutubeUtility.players = [];

      /**
       * Checks to see if there is an instance available, and if not appends one
       */
      Polymer.A11yMediaYoutubeUtility.requestAvailability = function() {
        if (!Polymer.A11yMediaYoutubeUtility.instance) {
          Polymer.A11yMediaYoutubeUtility.instance = document.createElement('a11y-media-youtube-utility');
        }

        document.body.appendChild(Polymer.A11yMediaYoutubeUtility.instance);
      };

      Polymer.A11yMediaYoutubeUtility.initYoutubePlayer = function(elem){
        let initialize = function(){
        }, player = new YT.Player(elem.id, {
          width: 600, //elem.width,
          height: 400, //elem.height,
          videoId: 'dxPVyieptwA', //elem.videoId,
          playerVars: {
            color: 'white',
            controls: 0,
            autoplay: 0,
            disablekb: 1,
            enablejsapi: 1,
            iv_load_policy: 3,
            modestbranding: 1,
            showinfo: 0, 
            rel: 0
          },
          events: {
            onReady: initialize
          }
        });
        player.play = function(){
          player.playVideo();
        }
        player.pause = function(){
          player.pauseVideo();
        }
        player.seek = function(time){
          player.seekTo(time);
        }
        player.setMute = function(mode){
          mode ? player.mute() : player.unMute();
        }
        player.duration = 10;
        player.seekable = {
          "length": 1,
          "start": function(index){ return 0 },
          "end": function(index){ return player.duration }
        };
        let int = setInterval(() => {
          if (player.getDuration !== undefined) {
            clearInterval(int);
            player.duration = player.getDuration();
          }
        });
        return player;
      };
      Polymer.A11yMediaYoutubeUtility.addPlayer = function(container){
        let root = this;
        root.players.push(container);
        if(root.apiReady){
          container.player = root.initYoutubePlayer(player);
        }
        return false;
      };
    })();
  </script>
</dom-module>
